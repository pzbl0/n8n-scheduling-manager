{
  "name": "scheduling-manager",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        0,
        0
      ],
      "id": "c32c119c-7801-441c-ac59-6c02aad53337",
      "name": "When chat message received",
      "webhookId": "684347a7-8eca-49a1-97cd-13a33e4961e2"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        224,
        224
      ],
      "id": "705005e1-6669-422b-9fe9-0ecf650fcfb3",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "leOLHYOtXey0DgzA",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1-kMMZU1dxDa8sBTYePBpR_RooNtSQ7r5kXgGn1TN4uk",
          "mode": "list",
          "cachedResultName": "Servicios",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-kMMZU1dxDa8sBTYePBpR_RooNtSQ7r5kXgGn1TN4uk/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 533323330,
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-kMMZU1dxDa8sBTYePBpR_RooNtSQ7r5kXgGn1TN4uk/edit#gid=533323330"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        480,
        224
      ],
      "id": "97ee48a1-e352-4ce8-a25d-a59dcddf09d4",
      "name": "services",
      "credentials": {
        "googleApi": {
          "id": "UDitTNIuZ8oToriK",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        352,
        224
      ],
      "id": "eb3a6fa6-2c0d-4aa4-b6bb-ba27e5b778dd",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "description": "=Hoy es: {{ $now.setLocale('es').format('EEEE d \\'de\\' MMMM\\' del\\' yyyy \\'y son las\\' h:mma') }}\nEl ID del calendario de Sinapzia es: \"688b6e729b7f5cf3f5ba66d058ac4b96ddf520350cc201c762696e38fb55839f@group.calendar.google.com\".\nEl ID del calendario de Pzblo es: \"sinapzia@gmail.com\".\n\n---\n\n## CAMPO \"calendar_id\":\n\n- Completa este campo con el ID de la agenda.\n- Para retornar los eventos de un usuario no hace falta completar este campo. Puedes dejarlo con un string vac\u00edo.\n- Para saber debes preguntarle al cliente si quiere agendar con Sinapzia o con Pzblo.\n\n---\n\n## CAMPO \"query\":\n\n- Completa este campo con informaci\u00f3n adicional sobre que evento el usuario quiere modificar o cancelar \u00fanicamente cuando tiene m\u00e1s de un evento agendado. La informaci\u00f3n adicional puede ser el nombre del evento/servicio o la fecha u hora exacta.\nEjemplos de \"query\":\n\"Modificar turno [dia, hora o servicio actual del turno a modificar], la nueva fecha es [dia y hora de la nueva fecha]\".\n\"Cancelar turno [dia, hora o servicio actual del turno a cancelar]\".\n- Si el cliente no quiere modificar/cancelar un turno o no tiene m\u00e1s de un evento agendado entonces completa este campo con un string vac\u00edo.\n\n---\n\n## CAMPO \"operation\":\n\n- Si la query es para averiguar disponibilidad completa este campo con \"get-availability\".\n- Si la query es para agendar completa este campo con \"create-event\".\n- Si la query es para retornar turnos ya agendados completa este campo con \"get-events\".\n- Si la query es para modificar un turno completa este campo con \"update-event\".\n- Si la query es para cancelar turno completa este campo con \"delete-event\".\n\n---\n\n## CAMPO \"event_date\":\n\n- Este campo es necesario unicamente si el cliente quiere agendar un turno. Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo.\n\n- Si \"operation\" es \"get-availability\" o \"create-event\" completa el campo \"event_date\" con el d\u00eda (puede ser una fecha exacta, o tamb\u00eden una referencia: hoy, ma\u00f1ana, el pr\u00f3ximo lunes, etc.) y la hora (puede ser una hora exacta o un rango: a las 14hs, a la ma\u00f1ana, a la tarde, en cualquier horario).\n\n- Si \"operation\" es \"update-event\" completa el campo \"event_date\" con el nuevo d\u00eda (puede ser una fecha exacta, o tamb\u00eden una referencia: hoy, ma\u00f1ana, el pr\u00f3ximo lunes, etc.) y la nueva hora (puede ser una hora exacta o un rango: a las 14hs, a la ma\u00f1ana, a la tarde, en cualquier horario).\n\n---\n\n## CAMPO \"client_name\":\n\n- Este campo es necesario unicamente si el cliente quiere agendar un turno. Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo.\n\n---\n\n## CAMPO \"event_reason\":\n\n- Este campo es necesario unicamente si el cliente quiere agendar un turno. Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo.\n- Completa este campo con el servicio que el cliente desea agendar. Para conocer si disponemos del servicio usa la herramienta \"services\".\n- Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo.\n\n---\n\n## CAMPO \"event_duration\":\n\n- Este campo es necesario unicamente si el cliente quiere agendar un turno. Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo.\n- Completa este campo con la duraci\u00f3n del servicio que el cliente desea agendar en minutos. Para conocer la duraci\u00f3n del servicio usa la herramienta \"services\".\n- Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo.\n\n---\n\n## INSTRUCCIONES:\n\n- Si el usuario quiere cambiar un turno entre agendas debes:\n  1. Averiguar el evento que quiere cambiar (vas a obtener el event_id y el calendar_id).\n  2. Eliminar el evento de la agenda actual (debes usar el calendar_id del evento actual que te fue retornado, no el nuevo).\n  3. Crear el evento en la agenda requerida (debes usar el calendar_id de la nueva agenda). Si solo quiere cambiar la agenda asegurate de mantener el dia, la hora y el nombre del sercicio y cliente.",
        "workflowId": {
          "__rl": true,
          "value": "MxMMxXA6QRfKqFWZ",
          "mode": "list",
          "cachedResultUrl": "/workflow/MxMMxXA6QRfKqFWZ",
          "cachedResultName": "scheduling-operation"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "client_id": 48984514735,
            "db_name": "sinapzia_agenda",
            "client_name": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('client_name', `Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo: \"\".`, 'string') }}",
            "event_duration": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('event_duration', `Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo: \"\".`, 'string') }}",
            "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('query', `Si el cliente no quiere modificar/cancelar un turno o no tiene m\u00e1s de un evento agendado entonces completa este campo con un string vac\u00edo: \"\".`, 'string') }}",
            "event_reason": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('event_reason', `Si el cliente no quiere agendar un turno completa este campo con un string vac\u00edo: \"\".`, 'string') }}",
            "ranges_to_schedule": "Lunes a Viernes de 10hs a 21hs",
            "operation": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('operation', ``, 'string') }}",
            "event_date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('event_date', `Si el cliente no quiere averiguar disponibilidad, agendar o modificar un turno completa este campo con un string vac\u00edo: \"\".`, 'string') }}",
            "calendar_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar_id', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "db_name",
              "displayName": "db_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "calendar_id",
              "displayName": "calendar_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "client_id",
              "displayName": "client_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "event_date",
              "displayName": "event_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "event_reason",
              "displayName": "event_reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "event_duration",
              "displayName": "event_duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "ranges_to_schedule",
              "displayName": "ranges_to_schedule",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        608,
        224
      ],
      "id": "146dad0a-e851-4fa8-9557-2dbb204f752f",
      "name": "scheduling-operation"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=## ROL:\n\nGestionas turnos usando tus herramientas.\n\n---\n\n## CONTEXTO:\n\nHoy es: {{ $now.setLocale('es').format('EEEE d \\'de\\' MMMM\\' del\\' yyyy \\'y son las\\' h:mma') }}\n\n---\n\n## REGLAS:\n\n- Nunca pases la lista completa de servicios. Solo da informaci\u00f3n del servicio que te pregunten.\n\n## HERRAMIENTAS:\n\n- `scheduling-operations`: Usa esta herramienta para gestionar turnos.\n- `services`: Usa esta herramienta para saber los servicios disponibles a agendar y su duraci\u00f3n.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        344,
        0
      ],
      "id": "e45e2836-f87d-4a5c-9761-0e02db923302",
      "name": "scheduling-manager"
    }
  ],
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "scheduling-manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "scheduling-manager",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "services": {
      "ai_tool": [
        [
          {
            "node": "scheduling-manager",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "scheduling-manager",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "scheduling-operation": {
      "ai_tool": [
        [
          {
            "node": "scheduling-manager",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}